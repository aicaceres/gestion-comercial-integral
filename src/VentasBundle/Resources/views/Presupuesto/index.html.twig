{% extends "AppBundle::layout.html.twig" %}
{% block pageheader %}
<div class="pageheader notab">
    <h1 class="pagetitle">Presupuestos</h1>
    <span class="pagedesc">Relación con Clientes</span>
</div><!--pageheader-->
{% endblock %}
{% block contentwrapper %}
{% include "AppBundle::notificacion.html.twig" %}

<div id="contentwrapper" class="contentwrapper">
<div>
    <form id="searchform" action="{{ path('ventas_presupuesto') }}" method="get">
        <div style="display: inline-block; margin-bottom: 10px;width:30%">
            &nbsp;&nbsp;&nbsp;
            <label><strong>Cliente:</strong></label>
            <select class="select2" id="selectCliente" name="cliId" style="width:80%">
                {% if cliente %}
                    <option value="{{cliente.id}}"> {{cliente.nombre }} </option>
                {% endif %}
            </select>
        </div>
        <div style="display: inline-block; margin-right: 30px;">
            &nbsp;&nbsp;&nbsp;
            <label><strong>Fecha Presupuesto: </strong></label>
            <input type="text" class="width100 datepicker" title="Fecha desde" value="{{desde}}" name="desde" id="desde" />
            <input type="text" class="width100 datepicker" title="Fecha hasta" value="{{hasta}}" name="hasta" id="hasta" />
            <a href="javascript:void(0)" class="editar btn btnaction btn_search" onClick="jQuery('#searchform').submit();" title="Buscar"></a>
        </div>
    </form>
</div><!-- button -->
    <table cellpadding="0" cellspacing="0" border="0" class="stdtable" id="dyntable2">
        <thead>
            <tr>
                <th>Nº Presupuesto</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
                <th class="nosort actionbutton addbutton">
                   {% if app.user.access(app.session.get('unidneg_id'),'ventas_presupuesto_new') %}
                    <a class="editar create" href="{{ path('ventas_presupuesto_new') }}">Nuevo Presupuesto</a>
                    {% else %} &nbsp; {% endif %}
                </th>
            </tr>
        </thead>
        <tbody>
           {% for entity in entities %}
            <tr>
                <td>{{entity.nroPresupuesto}}</td>
                <td><span class="hidden">{{ entity.fechaPresupuesto|date('Ymd') }}</span>{{ entity.fechaPresupuesto|date('d-m-Y') }}</td>
                <td>{% if entity.nombreCliente %} {{ entity.nombreCliente }} {% else %}  {{ entity.cliente }} {% endif %}</td>
                <td class="alignright">{{ entity.getTotal|number_format(3,'.',',') }}</td>
                <td class="buttons">
                    {% if entity.estado == 'ANULADO' %}
                        <strong style="height:26px;display:block;"> ANULADO: {{ entity.updated|date('d-m-Y H:i:s') }} | {{ entity.updatedBy.username }} </strong>
                    {% else %}
                     <a href="{{ path('ventas_presupuesto_show', { 'id': entity.id }) }}" class="editar btn btnaction btn_folder" title="Ver Presupuesto"></a>
                     <a href="#" url="{{ path('ventas_presupuesto_print', { 'id': entity.id })}}" class="editar btn btnaction btn_print" title="Imprimir Presupuesto"></a>
                    {% endif %}
                </td>
            </tr>
           {% endfor %}
        </tbody>
    </table>
</div>
 {% endblock %}
{% block extra_javascripts %}
{% include "AppBundle::block-list-js.html.twig" %}
<script type="text/javascript">
jQuery(document).ready(function($){
    $('.datepicker').datepicker({dateFormat: 'dd-mm-yy'});

    $('#selectCliente').select2({
            ajax: {
            url: "{{path('get_autocomplete_clientes')}}",
            type: "post",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                searchTerm: params.term // search term
                };
            },
            processResults: function (response) {
                return {
                    results: response
                };
            },
            cache: true
            },
            minimumInputLength: 3
        }).on('change', function(){
            $('#searchform').submit();
        });

    var oTable = $('#dyntable2').dataTable();
    oTable.fnSort( [ [1,'desc'],[0,'desc'] ] );

   $('#printform').on('submit',function(){
        $('#clienteid').val($('#selectCliente').val());
        $('#fdesde').val($('#desde').val());
        $('#fhasta').val($('#hasta').val());
        $('#searchterm').val( $('#dyntable2_filter input').val() );
        var datos = [];
        oTable.api().rows( { search:'applied' } ).data().each(function(value, index) {
            var i = value[1].indexOf('</span>');
            if( i >-1 ){
                var fecha = value[1].substr(i+7);
                value[1]=fecha;
            }
            value.splice(6);
            datos[index] = value;
        });
        $('#datalist').val(JSON.stringify(datos));
    });

});
</script>
{% endblock %}