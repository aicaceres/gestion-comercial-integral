{% extends "AppBundle::layout.html.twig" %}
{% block pageheader %}
<div class="pageheader notab">
    <h1 class="pagetitle">Apertura / Cierre de Caja</h1>
<span class="pagedesc">Listado de Aperturas y Cierres de Cajas</span> 
</div><!--pageheader-->
{% endblock %}
{% block contentwrapper %}
    {% include "AppBundle::notificacion.html.twig" %}

<div id="contentwrapper" class="contentwrapper">
{# fomulario para filtros #}
    <form id="searchform" action="{{ path('ventas_apertura') }}" method="get" style="margin-bottom:10px">            
        <div style="display: none; margin-bottom: 10px;">
            &nbsp;&nbsp;&nbsp;
            <label><strong>Caja:</strong></label>
            <select class="uniformselect" id="selectCaja" name="cajaId">                
            {% for cj in cajas %}
                <option value="{{cj.id}}" {% if cj.id==cajaId %} selected="selected" {% endif %}> {{cj.nombre}}</option>
            {% endfor %}
            </select>  
        </div>    
        <div style="display: inline-block; margin-right: 30px;">     
            &nbsp;&nbsp;&nbsp;
            <label><strong>Fecha: </strong></label>
            <input type="text" class="width100 datepicker" title="Fecha desde" value="{{desde}}" name="desde" id="desde" /> 
            <input type="text" class="width100 datepicker" title="Fecha hasta" value="{{hasta}}" name="hasta" id="hasta" /> 
            <a href="javascript:void(0)" class="editar btn btnaction btn_search" onClick="jQuery('#searchform').submit();" title="Buscar"></a>            
        </div>           
    </form> 
  
{# Banner con estado de la caja #}
{% if caja %}
    {% if caja.abierta %}
        {% set msg, txt = 'msgsuccess', caja.nombre ~ ' ABIERTA' %}  
        {% set btn = '<button title="Realizar el Cierre de Caja" class="js-cierre stdbtn btn_black floatright" > Cierre de Caja </button>'  %}
    {% else %}
        {% set msg, txt = 'msgerror', caja.nombre ~ ' CERRADA' %}  
        {% set btn = '<button title="Realizar la Apertura de Caja" class="js-apertura stdbtn btn_black floatright" > Apertura de Caja </button>'  %}  
    {% endif %}
    <div class="notibar {{msg}}">                
        <p>
            <strong> {{txt}} </strong> {{ btn|raw }}
        </p>
    </div>    
{% endif %}

    <table cellpadding="0" cellspacing="0" border="0" class="stdtable" id="ccaja_apertura_table">       
        <thead>
            <tr>
                <th class="nosort">#</th>
                <th class="nosort">Apertura</th>
                <th class="nosort">Monto</th>
                <th class="nosort">Usuario</th>
                <th class="nosort" style="background:#868686;padding:1px;"></th>
                <th class="nosort">Cierre</th>
                <th class="nosort">Monto</th>
                <th class="nosort">Usuario</th>
                <th class="nosort">DIFERENCIA</th>
                <th class="nosort" style="width:5%"></th>
            </tr>
        </thead>
        <tbody>
            {% for apertura in entities|reverse %}
                {% if loop.index<40 %}
                    <tr>
                        <td>{{ apertura.id }}</td>
                        <td>{{ apertura.fechaApertura|date('d-m-Y H:i') }}</td>
                        <td>{{ apertura.montoApertura|number_format(2,'.',',') }}</td>
                        <td>{{ apertura.createdBy.username|upper }}</td>
                        <td style="background:#868686;padding:1px;"></td>
                        <td>{% if apertura.fechaCierre %}{{apertura.fechaCierre|date('d-m-Y H:i')}}{% endif %}</td>
                        <td>{% if apertura.fechaCierre  %}{{apertura.montoCierre|number_format(2,'.',',')}}{% endif %}</td>
                        <td>{% if apertura.fechaCierre %}{{ apertura.updatedBy.username }}{% endif %}</td>
                        <td class="{% if apertura.diferencia<0 %} rojo {% endif %}" >{% if apertura.fechaCierre %}{{apertura.diferencia|number_format(2,'.',',')}}{% endif %}</td>
                        <td>{% if apertura.fechaCierre %}
                            <a href="#" title="Ver informe de Cierre" class="btn mini purple"> <i class="icon-file"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}           
        </tbody>
    </table> 
</div>

{% endblock %}
{% block extra_javascripts %}
{% include "AppBundle::block-list-js.html.twig" %}
<script type="text/javascript">
jQuery(document).ready(function($){
    $('#selectCaja').change(function(){ 
        $('#searchform').submit();
    }); 
    $('.datepicker').datepicker({dateFormat: 'dd-mm-yy'});    

    $('.js-apertura').on('click', function(){
        //caja_id = $('#selectCaja').val();  id de caja
        url = '{{ path("ventas_apertura_new")}}'; // url del partial a cargar en modal        
        aperturaCajaVentas(url)
    });
    $('.js-cierre').on('click', function(){
        //caja_id = $('#selectCaja').val();  id de caja
        url = '{{ path("ventas_cierre_new")}}'; // url del partial a cargar en modal        
        cierreCajaVentas(url)
    });
});
</script>     
{% endblock %}